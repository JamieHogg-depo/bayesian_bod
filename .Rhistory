# Base map with boxes
#base_boxes <- base_legend + addBoxLabel(1, color = "green", size = 0.2)
base_boxes <- base + addBoxLabel(1, color = "green", size = 0.2)
# Create list of insets
perth_inset <- base +
xlim(lims$xmin[1], lims$xmax[1]) +
ylim(lims$ymin[1], lims$ymax[1]) +
theme(panel.border = element_rect(colour = "black", size=1, fill=NA),
plot.title = element_text(margin = margin(0,0,2,0)),
plot.margin = unit(c(1,1,1,1), "mm"))
# create full map
lay <- rbind(c(2,1,1),
c(1,1,1),
c(1,1,1))
year_plt_list[[t]] <- grid.arrange(grobs = list(base_boxes, perth_inset), layout_matrix  = lay,
top = textGrob(as.character(seq_years[t]),gp=gpar(fontsize=20)))
# Keep track
message("Finished ", t)
}
year_plt_list[[1]]+year_plt_list[[2]]
class(base)
class(year_plt_list[[1]])
## -----------------------------------------------------------------------------
## Setup ## --------------------------------------------------------------------
## -----------------------------------------------------------------------------
# Packages
library(tidyverse)
library(scales)
library(sf)
library(MASS)
library(patchwork)
library(readr)
library(readxl)
library(grid)
library(gridExtra)
rm(list = ls())
export <- FALSE
## Functions ## ----------------------------------------------------------------
jsave <- function(filename, base_folder,
plot = last_plot(),
square = T, square_size = 5000,
ratio = c(6,9)){
if(square){
ggsave(filename = filename,
plot = plot,
path = base_folder,
dpi = 1000,
width = square_size,
height = square_size,
scale = 1,
units = "px")
}else{
total = square_size^2
a <- sqrt((total*ratio[1])/ratio[2])
b <- (ratio[2]*a)/ratio[1]
ggsave(filename = filename,
plot = plot,
path = base_folder,
dpi = 1000,
width = round(b),
height = round(a),
scale = 1,
units = "px")
}
}
make_numeric_decimal <- function(.data){
df <- .data
cols_to_format <- unlist(lapply(df, is.numeric))
df[,cols_to_format] <- bind_cols(lapply(df[,cols_to_format], sprintf, fmt = '%#.2f'))
return(df)
}
addBoxLabel <- function(i, color = "white", size = 0.5){
list(
annotate("rect",
xmin = lims$xmin[i], xmax = lims$xmax[i],
ymin = lims$ymin[i], ymax = lims$ymax[i],
color = color, fill = NA, size = size)
)
}
## Load Data ## ----------------------------------------------------------------
# Load mappopData
load("data/mappopDATA.Rdata")
rm(age_labs, hd, hr, hr_labs, sa2)
map <- lga$map %>%
mutate(geography_no = as.integer(LGA_CODE16))
# Load model results
files_to_load = list.files("data/YLLoutputs20CHD20230614013642", pattern = "*.csv", full.names = T)
df_list = lapply(files_to_load, read.csv)
names(df_list) <- str_remove(list.files("data/YLLoutputs20CHD20230614013642"), " count table_deleted y.csv")
## Other code ## --------------------------------------------------------------
# City Insets
lims <- data.frame(
xmin = c(152.6, 150.35, 144.5, 115.45, 138.1, 146.8, 148.6, 130.3),
xmax = c(153.6, 151.35, 145.5, 116.45, 139.1, 147.8, 149.6, 131.3),
ymin = -c(28, 34.4, 38.4, 32.5, 35.4, 43.4, 35.8, 13),
ymax = -c(27, 33.4, 37.4, 31.5, 34.4, 42.4, 34.8, 12),
city = c("Brisbane", "Sydney", "Melbourne", "Perth", "Adelaide", "Hobart", "Canberra", "Darwin"),
position = c("r", "r", "b", "l", "b", "b", "r", "l"),
inset_labs = c("B - Brisbane (Qld)", "S - Sydney (NSW)",
"M - Melbourne (Vic)", "P - Perth (WA)",
"A - Adelaide (SA)", "H - Hobart (Tas)",
"C - Canberra (ACT)", "D - Darwin (NT)")
) %>%
mutate(initials = str_sub(city, 1, 1)) %>%
filter(city == "Perth")
## END SCRIPT ## --------------------------------------------------------------
library(ggpubr)
map_obj <- list()
# create map data list
map_obj$female_yll <- left_join(df_list$`LGA_CHD_Female YLL`,
map, by = "geography_no") %>%
st_as_sf() %>%
st_transform(4326) %>%
# WA outline
wa_border <- map %>%
summarise(geometry = st_union(geometry)) %>%
st_as_sf() %>%
st_transform(4326)
map_obj <- list()
# create map data list
map_obj$female_yll <- left_join(df_list$`LGA_CHD_Female ASYLL`,
map, by = "geography_no") %>%
st_as_sf() %>%
st_transform(4326)
# WA outline
wa_border <- map %>%
summarise(geometry = st_union(geometry)) %>%
st_as_sf() %>%
st_transform(4326)
df_list$`LGA_CHD_Female ASYLL` %>% view()
year_plt_list <- list()
seq_years <- unique(df_list$`LGA_CHD_Female ASYLL`$year)
t <- 1
col_range <- range(map_obj$female_yll$point)
# base map - no legend
base <- map_obj$female_yll %>%
filter(T_id == t) %>%
ggplot(aes(fill = point))+
theme_void()+
geom_sf(col = "grey", size = 0.1)+
geom_sf(data = wa_border, aes(geometry = geometry),
colour = "black", fill = NA, size = 0.3)+
scale_fill_viridis_c(begin = 0, end = 1,
direction = -1,
option = "B", limits = col_range)+
labs(fill = "YLL")+
theme(legend.position = "none",
text = element_text(size = 4),
plot.title = element_text(margin = margin(0,0,2,0)),
plot.margin = unit(c(1,1,1,1), "mm"))
# base map_with legend
temp <- base +
labs(fill = "YLL")+
guides(fill = guide_colourbar(barwidth = 15,
title.position = "top",
title.hjust = 0.5))+
theme(legend.position = "bottom")
base_legend <- get_legend(temp)
base_boxes <- base + addBoxLabel(1, color = "black", size = 0.2)
# Create list of insets
perth_inset <- base +
xlim(lims$xmin[1], lims$xmax[1]) +
ylim(lims$ymin[1], lims$ymax[1]) +
theme(panel.border = element_rect(colour = "black", size=1, fill=NA),
plot.title = element_text(margin = margin(0,0,2,0)),
plot.margin = unit(c(1,1,1,1), "mm"))
lay <- rbind(c(2,1,1),
c(1,1,1),
c(1,1,1),
c(3,3,3))
year_plt_list[[t]] <- grid.arrange(grobs = list(base_boxes, perth_inset, base_legend),
layout_matrix  = lay,
top = textGrob(as.character(seq_years[t]),gp=gpar(fontsize=20)))
# LGA_CHD_Female ASYLL
year_plt_list <- list()
seq_years <- unique(df_list$`LGA_CHD_Female ASYLL`$year)
# loop over years
for(t in 1:6){
# range of posterior medians
col_range <- range(map_obj$female_yll$point)
# base map - no legend
base <- map_obj$female_yll %>%
filter(T_id == t) %>%
ggplot(aes(fill = point))+
theme_void()+
geom_sf(col = "grey", size = 0.1)+
geom_sf(data = wa_border, aes(geometry = geometry),
colour = "black", fill = NA, size = 0.3)+
scale_fill_viridis_c(begin = 0, end = 1,
direction = -1,
option = "B", limits = col_range)+
labs(fill = "YLL")+
theme(legend.position = "none",
text = element_text(size = 4),
plot.title = element_text(margin = margin(0,0,2,0)),
plot.margin = unit(c(1,1,1,1), "mm"))
# base map_with legend
temp <- base +
labs(fill = "YLL")+
guides(fill = guide_colourbar(barwidth = 15,
title.position = "top",
title.hjust = 0.5))+
theme(legend.position = "bottom")
base_legend <- get_legend(temp)
# Base map with boxes
#base_boxes <- base_legend + addBoxLabel(1, color = "green", size = 0.2)
base_boxes <- base + addBoxLabel(1, color = "black", size = 0.2)
# Create list of insets
perth_inset <- base +
xlim(lims$xmin[1], lims$xmax[1]) +
ylim(lims$ymin[1], lims$ymax[1]) +
theme(panel.border = element_rect(colour = "black", size=1, fill=NA),
plot.title = element_text(margin = margin(0,0,2,0)),
plot.margin = unit(c(1,1,1,1), "mm"))
# create full map
lay <- rbind(c(2,1,1),
c(1,1,1),
c(1,1,1))
year_plt_list[[t]] <- grid.arrange(grobs = list(base_boxes, perth_inset),
layout_matrix  = lay,
top = textGrob(as.character(seq_years[t]),gp=gpar(fontsize=20)))
# Keep track
message("Finished ", t)
}
lay <- rbind(c(1,2,3),
c(4,5,6),
c(7,7,7))
?grid.arrange
full_inset_plt <- arrangeGrob(grobs = c(year_plt_list, list(base_legend)), layout_matrix  = lay)
plot(full_inset_plt)
jsave(plot = full_inset_plt, filename = "female_chd_asyll.png", base_folder = "plts", square = F)
# LGA_CHD_Female ASYLL
year_plt_list <- list()
seq_years <- unique(df_list$`LGA_CHD_Female ASYLL`$year)
# loop over years
for(t in 1:6){
# range of posterior medians
col_range <- range(map_obj$female_yll$point)
# base map - no legend
base <- map_obj$female_yll %>%
filter(T_id == t) %>%
ggplot(aes(fill = point))+
theme_void()+
geom_sf(col = "grey", size = 0.1)+
geom_sf(data = wa_border, aes(geometry = geometry),
colour = "black", fill = NA, size = 0.3)+
scale_fill_viridis_c(begin = 0, end = 1,
direction = -1,
option = "B", limits = col_range)+
labs(fill = "YLL")+
theme(legend.position = "none",
text = element_text(size = 20),
plot.title = element_text(margin = margin(0,0,2,0)),
plot.margin = unit(c(1,1,1,1), "mm"))
# base map_with legend
temp <- base +
labs(fill = "YLL")+
guides(fill = guide_colourbar(barwidth = 15,
title.position = "top",
title.hjust = 0.5))+
theme(legend.position = "bottom")
base_legend <- get_legend(temp)
# Base map with boxes
#base_boxes <- base_legend + addBoxLabel(1, color = "green", size = 0.2)
base_boxes <- base + addBoxLabel(1, color = "black", size = 0.2)
# Create list of insets
perth_inset <- base +
xlim(lims$xmin[1], lims$xmax[1]) +
ylim(lims$ymin[1], lims$ymax[1]) +
theme(panel.border = element_rect(colour = "black", size=1, fill=NA),
plot.title = element_text(margin = margin(0,0,2,0)),
plot.margin = unit(c(1,1,1,1), "mm"))
# create full map
lay <- rbind(c(2,1),
c(1,1))
year_plt_list[[t]] <- arrangeGrob(grobs = list(base_boxes, perth_inset),
layout_matrix  = lay,
top = textGrob(as.character(seq_years[t]),gp=gpar(fontsize=20)))
# Keep track
message("Finished ", t)
}
# Final plot
lay <- rbind(c(1,2,3),
c(4,5,6),
c(7,7,7))
full_inset_plt <- arrangeGrob(grobs = c(year_plt_list, list(base_legend)), layout_matrix  = lay)
jsave(plot = full_inset_plt, filename = "female_chd_asyll.png", base_folder = "plts", square = F)
# LGA_CHD_Female ASYLL
year_plt_list <- list()
seq_years <- unique(df_list$`LGA_CHD_Female ASYLL`$year)
# loop over years
for(t in 1:6){
# range of posterior medians
col_range <- range(map_obj$female_yll$point)
# base map - no legend
base <- map_obj$female_yll %>%
filter(T_id == t) %>%
ggplot(aes(fill = point))+
theme_void()+
geom_sf(col = "grey", size = 0.1)+
geom_sf(data = wa_border, aes(geometry = geometry),
colour = "black", fill = NA, size = 0.2)+
scale_fill_viridis_c(begin = 0, end = 1,
direction = -1,
option = "B", limits = col_range)+
labs(fill = "YLL")+
theme(legend.position = "none",
text = element_text(size = 10),
plot.title = element_text(margin = margin(0,0,2,0)),
plot.margin = unit(c(1,1,1,1), "mm"))
# base map_with legend
temp <- base +
labs(fill = "YLL")+
guides(fill = guide_colourbar(barwidth = 15,
title.position = "top",
title.hjust = 0.5))+
theme(legend.position = "bottom")
base_legend <- get_legend(temp)
# Base map with boxes
#base_boxes <- base_legend + addBoxLabel(1, color = "green", size = 0.2)
base_boxes <- base + addBoxLabel(1, color = "black", size = 0.2)
# Create list of insets
perth_inset <- base +
xlim(lims$xmin[1], lims$xmax[1]) +
ylim(lims$ymin[1], lims$ymax[1]) +
theme(panel.border = element_rect(colour = "black", size=0.2, fill=NA),
plot.title = element_text(margin = margin(0,0,2,0)),
plot.margin = unit(c(1,1,1,1), "mm"))
# create full map
lay <- rbind(c(2,1),
c(1,1))
year_plt_list[[t]] <- arrangeGrob(grobs = list(base_boxes, perth_inset),
layout_matrix  = lay,
top = textGrob(as.character(seq_years[t]),gp=gpar(fontsize=10)))
# Keep track
message("Finished ", t)
}
# Final plot
lay <- rbind(c(1,2,3),
c(4,5,6),
c(7,7,7))
full_inset_plt <- arrangeGrob(grobs = c(year_plt_list, list(base_legend)), layout_matrix  = lay)
jsave(plot = full_inset_plt, filename = "female_chd_asyll.png", base_folder = "plts", square = F)
# LGA_CHD_Female ASYLL
year_plt_list <- list()
seq_years <- unique(df_list$`LGA_CHD_Female ASYLL`$year)
# loop over years
for(t in 1:6){
# range of posterior medians
col_range <- range(map_obj$female_yll$EP)
# base map - no legend
base <- map_obj$female_yll %>%
filter(T_id == t) %>%
ggplot(aes(fill = EP))+
theme_void()+
geom_sf(col = "grey", size = 0.1)+
geom_sf(data = wa_border, aes(geometry = geometry),
colour = "black", fill = NA, size = 0.2)+
scale_fill_viridis_c(begin = 0, end = 1,
direction = -1,
option = "B", limits = col_range)+
labs(fill = "YLL")+
theme(legend.position = "none",
text = element_text(size = 10),
plot.title = element_text(margin = margin(0,0,2,0)),
plot.margin = unit(c(1,1,1,1), "mm"))
# base map_with legend
temp <- base +
labs(fill = "YLL")+
guides(fill = guide_colourbar(barwidth = 15,
title.position = "top",
title.hjust = 0.5))+
theme(legend.position = "bottom")
base_legend <- get_legend(temp)
# Base map with boxes
#base_boxes <- base_legend + addBoxLabel(1, color = "green", size = 0.2)
base_boxes <- base + addBoxLabel(1, color = "black", size = 0.2)
# Create list of insets
perth_inset <- base +
xlim(lims$xmin[1], lims$xmax[1]) +
ylim(lims$ymin[1], lims$ymax[1]) +
theme(panel.border = element_rect(colour = "black", size=0.2, fill=NA),
plot.title = element_text(margin = margin(0,0,2,0)),
plot.margin = unit(c(1,1,1,1), "mm"))
# create full map
lay <- rbind(c(2,1),
c(1,1))
year_plt_list[[t]] <- arrangeGrob(grobs = list(base_boxes, perth_inset),
layout_matrix  = lay,
top = textGrob(as.character(seq_years[t]),gp=gpar(fontsize=10)))
# Keep track
message("Finished ", t)
}
# Final plot
lay <- rbind(c(1,2,3),
c(4,5,6),
c(7,7,7))
full_inset_plt <- arrangeGrob(grobs = c(year_plt_list, list(base_legend)), layout_matrix  = lay)
jsave(plot = full_inset_plt, filename = "female_chd_asyll.png", base_folder = "plts", square = F)
# LGA_CHD_Female ASYLL
year_plt_list <- list()
seq_years <- unique(df_list$`LGA_CHD_Female ASYLL`$year)
# loop over years
for(t in 1:6){
# range of posterior medians
col_range <- range(map_obj$female_yll$point)
# base map - no legend
base <- map_obj$female_yll %>%
filter(T_id == t) %>%
ggplot(aes(fill = point))+
theme_void()+
geom_sf(col = "grey", size = 0.1)+
geom_sf(data = wa_border, aes(geometry = geometry),
colour = "black", fill = NA, size = 0.2)+
scale_fill_viridis_c(begin = 0, end = 1,
direction = -1,
option = "B", limits = col_range)+
labs(fill = "ASYLL")+
theme(legend.position = "none",
text = element_text(size = 10),
plot.title = element_text(margin = margin(0,0,2,0)),
plot.margin = unit(c(1,1,1,1), "mm"))
# base map_with legend
temp <- base +
labs(fill = "YLL")+
guides(fill = guide_colourbar(barwidth = 15,
title.position = "top",
title.hjust = 0.5))+
theme(legend.position = "bottom")
base_legend <- get_legend(temp)
# Base map with boxes
#base_boxes <- base_legend + addBoxLabel(1, color = "green", size = 0.2)
base_boxes <- base + addBoxLabel(1, color = "black", size = 0.2)
# Create list of insets
perth_inset <- base +
xlim(lims$xmin[1], lims$xmax[1]) +
ylim(lims$ymin[1], lims$ymax[1]) +
theme(panel.border = element_rect(colour = "black", size=0.2, fill=NA),
plot.title = element_text(margin = margin(0,0,2,0)),
plot.margin = unit(c(1,1,1,1), "mm"))
# create full map
lay <- rbind(c(2,1),
c(1,1))
year_plt_list[[t]] <- arrangeGrob(grobs = list(base_boxes, perth_inset),
layout_matrix  = lay,
top = textGrob(as.character(seq_years[t]),gp=gpar(fontsize=10)))
# Keep track
message("Finished ", t)
}
# Final plot
lay <- rbind(c(1,2,3),
c(4,5,6),
c(7,7,7))
full_inset_plt <- arrangeGrob(grobs = c(year_plt_list, list(base_legend)), layout_matrix  = lay)
jsave(plot = full_inset_plt, filename = "female_chd_asyll.png", base_folder = "plts", square = F)
## END SCRIPT ## --------------------------------------------------------------
# LGA_CHD_Female ASYLL
year_plt_list <- list()
seq_years <- unique(df_list$`LGA_CHD_Female ASYLL`$year)
# loop over years
for(t in 1:6){
# range of posterior medians
col_range <- range(map_obj$female_yll$point)
# base map - no legend
base <- map_obj$female_yll %>%
filter(T_id == t) %>%
ggplot(aes(fill = point))+
theme_void()+
geom_sf(col = "grey", size = 0.1)+
geom_sf(data = wa_border, aes(geometry = geometry),
colour = "black", fill = NA, size = 0.2)+
scale_fill_viridis_c(begin = 0, end = 1,
direction = -1,
option = "B", limits = col_range)+
theme(legend.position = "none",
text = element_text(size = 10),
plot.title = element_text(margin = margin(0,0,2,0)),
plot.margin = unit(c(1,1,1,1), "mm"))
# base map_with legend
temp <- base +
labs(fill = "ASYLL")+
guides(fill = guide_colourbar(barwidth = 15,
title.position = "top",
title.hjust = 0.5))+
theme(legend.position = "bottom")
base_legend <- get_legend(temp)
# Base map with boxes
#base_boxes <- base_legend + addBoxLabel(1, color = "green", size = 0.2)
base_boxes <- base + addBoxLabel(1, color = "black", size = 0.2)
# Create list of insets
perth_inset <- base +
xlim(lims$xmin[1], lims$xmax[1]) +
ylim(lims$ymin[1], lims$ymax[1]) +
theme(panel.border = element_rect(colour = "black", size=0.2, fill=NA),
plot.title = element_text(margin = margin(0,0,2,0)),
plot.margin = unit(c(1,1,1,1), "mm"))
# create full map
lay <- rbind(c(2,1),
c(1,1))
year_plt_list[[t]] <- arrangeGrob(grobs = list(base_boxes, perth_inset),
layout_matrix  = lay,
top = textGrob(as.character(seq_years[t]),gp=gpar(fontsize=10)))
# Keep track
message("Finished ", t)
}
# Final plot
lay <- rbind(c(1,2,3),
c(4,5,6),
c(7,7,7))
full_inset_plt <- arrangeGrob(grobs = c(year_plt_list, list(base_legend)), layout_matrix  = lay)
jsave(plot = full_inset_plt, filename = "female_chd_asyll.png", base_folder = "plts", square = F)
## END SCRIPT ## --------------------------------------------------------------
